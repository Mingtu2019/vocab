<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lists of items with lists as word lists</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="theme.css">
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.min.js" integrity="sha256-xKWJpqP3ZjhipWOyzFuNmG2Zkp1cW4nhUREGBztcSXs=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autosize.js/4.0.0/autosize.min.js" integrity="sha256-F7Bbc+3hGv34D+obsHHsSm3ZKRBudWR7e2H0fS0beok=" crossorigin="anonymous"></script>
<script>
function nameEditor(name, value)
{
  return '<div class="input-group nameeditor"><span class="input-group-btn"><button class="btn btn-danger"><span class="fa fa-trash"></span></button><button class="btn btn-warning"><span class="fa fa-times"></span></button><button class="btn btn-success"><span class="fa fa-check"></span></button></span><textarea class="form-control" type="text" rows=1 placeholder="' + name + '">' + value + '</textarea></div>';
}

function textEditor(name, value)
{
  return '<div class="input-group texteditor"><span class="input-group-addon">' + name + '</span><input class="form-control" type="text" value="' + value + '"></div>';
}

// {{{ HTML word display
function disp(s) {
  return s.replace(/\\n/g, '\n').replace(/<[^>]*>/g, function(s) {
    var href = s.substring(1, s.length - 1);
    return '<a href="' + href + '">' + href + '</a>'
  }).replace(/\n/g, '|\n').replace(/[^|\n]*(\||$)/g, function(s) {
    if (s.search('`') == -1)
      return s;
    return '<ruby>' + s.replace(/`[^`]*?(`|$)/g, function(s) {
      return '<rp>(</rp><rt>' + s + '</rt><rp>)</rp>';
    }) + '</ruby>';
  }).replace(/[|`]/g, '').replace(/\n/g, '<br>');
}

function dispStyle(type) {
  if (type in style)
    return 'style="' + style[type] + '"';
  else
    return '';
}

function wordDisp(obj) {
  var info = {};
  try {
    info = JSON.parse(obj.info);
  } catch (e) {
    alert(e);
  };
  var html = '<table class="table table-condensed"><tbody>';
  for (field in info) {
    html = html.concat('<tr><th class="fit">', field, '</th><td ' + dispStyle(field) + '>', disp(info[field]), '</td></tr>');
  }
  return html.concat('</tbody></table>');
}

function wordElement(word) {
  return '<li class="list-group-item" wid="' + word.id + '"><h4 class="list-group-item-heading" ' + dispStyle('word') + '>' + disp(word.word) + '<div class="btn-group"><button class="btn btn-sm btn-warning"><span class="fa fa-pencil"></span></button><button class="btn btn-sm btn-info"><span class="fa fa-copy"></span></button></div></h4><p class="list-group-item-text"><table><tbody>' + wordDisp(word) + '</tbody></table></li>';
}
// }}}

// {{{ JSON editor functions
function jsonedit(json) {
  if (json === "")
    return '';
  var obj = {};
  try {
    obj = JSON.parse(json);
  } catch (e) {
    alert(e);
  };
  var html = '';
  for (field in obj)
    html = html.concat(jsonfield(field, obj[field]));
  return html.concat(jsonfield('', ''));
}

function jsonfield(field, value) {
  return '<tr><th class="fit"><div class="input-group"><div class="input-group-btn"><button class="btn ' +
    (field ? 'btn-danger' : 'btn-success') + '"><span class="fa ' + (field ? 'fa-times' : 'fa-plus') +
    '"></span></button></div><input class="form-control" type="text" id="field" value="' + field +
    '"></div></th><td><textarea class="form-control" type="text" rows=1 id="value">' + value + '</textarea></td></tr>';
}

function jsonobj(table) {
  var obj = {};
  $(table).find("tr").each(function() {
    var field = $(this).find("th input").val();
    var value = $(this).find("td textarea").val();
    if (field != '' && value != '')
      obj[field] = value;
  });
  return obj;
}

$('body').on('click', '.jsonedit .btn-success', function() {
  var tr = $(this).closest('tr');
  var field = tr.find('#field').val();
  var value = tr.find('#value').val();
  if (field === "")
    return;
  $(this).removeClass('btn-success');
  $(this).addClass('btn-danger');
  $(this).children().removeClass('fa-plus');
  $(this).children().addClass('fa-times');
  tr.parent().append(jsonfield('', ''));
  autosize(tr.parent().find('tr').last().find('textarea'));
});

$('body').on('click', '.jsonedit .btn-danger', function() {
  $(this).closest('tr').remove();
});
// }}}
</script>

<div class="container theme-showcase" role="main">

  <!-- {{{ Section tabs -->
  <nav class="nav nav-tabs" role="tablist" id="sectabs"></nav>
  <script>
function refreshSections()
{
  $.getJSON("get/section_list.php", function(res) {
    var html = '';
    for (i in res) {
      var obj = res[i];
      var id = obj['id'];
      var name = obj['name'];
      html = html.concat('<a class="nav-item nav-link align-self-end" href="#section" section="', id, '" data-toggle="tab">', disp(name), '</a>');
    }
    html = html.concat('<a class="nav-item nav-link align-self-end" href="#section" section="add"><span class="fa fa-plus"></span></a>');
    $('#sectabs').html(html);
    refreshUnits(null);
    section = '';
    $('#edit_section').hide(ani);
    $('#edit_word').hide(ani);
  });
}

var section = ''
var secobj = {};
var style = {}, weight = {};
$('#sectabs').on('click', 'a', function() {
  var secid = $(this).attr('section');
  if (secid == "add")
    addSection();
  else if (secid != section) {
    var a = $(this);
    $.getJSON("get/section.php?id=" + secid, function(obj) {
      refreshUnits(secid);
      secobj = obj;
      section = obj.id;
      style = JSON.parse(obj.style);
      if (style == null)
        style = {};
      weight = JSON.parse(obj.weight);
      if (weight == null)
        weight = {};
      a.closest('nav').find('.btn-warning').remove();
      a.append('<button class="btn btn-xs btn-warning"><span class="fa fa-pencil"></span></button>');
      $('#edit_section').hide(ani);
      $('#edit_word').show(ani);
    });
  }
});
  </script>
  <!-- }}} -->

  <!-- {{{ Section editor -->
  <div id="edit_section" style="display:none">
    <p>
    <div class="card">
      <div id="section_id" class="card-header bg-warning">Edit section #</div>
      <div class="card-body" id="section_name">
        <script>document.write(nameEditor('Section name', ''));</script>
      </div>
      <ul class="list-group">
        <li class="list-group-item list-group-item-info">
          Style settings
          <table class="table table-no-border">
            <tbody id="section_style" class="jsonedit"></tbody>
          </table>
        </li>
        <li class="list-group-item list-group-item-danger">
          Word weights
          <table class="table table-no-border">
            <tbody id="section_weight" class="jsonedit"></tbody>
          </table>
        </li>
      </ul>
    </div>
  </div>
  <script>
function refreshEditSection()
{
  $('#section_id').text('Edit section #' + secobj.id);
  $('#section_name textarea').val(secobj.name);
  autosize.update($('#section_name textarea'));
  $('#section_style').html(jsonedit(secobj.style));
  $('#section_weight').html(jsonedit(secobj.weight));
  autosize($('#edit_section textarea'));
}

$('#sectabs').on('click', '.btn-warning', function() {
  $('#edit_section').toggle(ani, function() {
    refreshEditSection();
  });
});

$('#edit_section .card-header').click(function() {$('#edit_section').hide(ani);});
$('#section_name .nameeditor .btn-warning').click(function() {$('#edit_section').hide(ani);});

$('#section_name .nameeditor .btn-success').click(function() {
  var obj = {id: section};
  obj['name'] = $('#section_name textarea').val();
  obj['style'] = JSON.stringify(jsonobj($('#section_style')));
  obj['weight'] = JSON.stringify(jsonobj($('#section_weight')));
  $.post("set/section.php", JSON.stringify(obj), function(res) {
    if (res !== 'OK')
      alert("Save unsuccessful");
    else
      refreshSections();
  });
});

$('#section_name .nameeditor .btn-danger').click(function() {
  if (confirm('DELETE section #' + section + '?'))
    $.post('set/delete_section.php', 'id=' + section, refreshSections);
});
  </script>
  <!-- }}} -->

  <!-- {{{ Unit tabs -->
  <p>
  <nav class="nav nav-pills" role="tablist" id="unittabs"></nav>
  <script>
var unit = '';
function refreshUnits(secid) {
  if (secid == null) {
    $('#unittabs').html('');
    unit = '';
    $('.container > #word_list').hide(ani);
    return;
  }
  if (secid != section)
      unit = '';
  $.getJSON('get/unit_list.php?id=' + secid, function(array) {
    var found = false;
    var html = '';
    for (i in array) {
      var name = array[i][0];
      if (name == unit) {
        html = html.concat('<a class="nav-item nav-link align-self-end" href="#unit" name="', name, '" data-toggle="pill" role="tab">', disp(name), '</a>');
        found = true;
      } else {
        html = html.concat('<a class="nav-item nav-link align-self-end" href="#unit" name="', name, '" data-toggle="pill" role="tab">', disp(name), '</a>');
      }
    }
    html = html.concat('<a class="nav-item nav-link align-self-end" href="#unit" type="import"><span class="fa fa-upload"></span></a>');
    $('#unittabs').html(html);
    if (found == false)
      $('.container > #word_list').hide(ani);
  });
}

$('#unittabs').on('click', 'a', function() {
  if ($(this).attr('type') == 'import') {
    importUnit();
    return;
  }
  unit = $(this).attr('name');
  if (unit == '')
    return;
  refreshWords(unit);
  refreshEditWord(unit);
});
  </script>
  <!-- }}} -->

  <!-- {{{ Unit import dialog -->
  <div id="unit_import" class="modal fade" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Import unit from file</h4>
          <button type="button" class="close" data-dismiss="modal"><span class="fa fa-times"></span></button>
        </div>
        <div class="modal-body">
          <script>document.write(textEditor('Unit', ''));</script><p>
          <div class="input-group"><span class="input-group-addon"><a href="https://gist.github.com/zhiyb/70db96cfedbe494b729db2f4d6c1938d">Anki CSV</a>&nbsp;import</span><input class="form-control" type="file" id="csv_file"></div><p>
          <div id="word_list" style="display:none"><ul class="list-group"></ul></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Import</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
function importWordTable(e) {
  var html = '<table class="table table-condensed"><tbody>';
  var field;
  for (field in e) {
    html = html.concat('<tr><th class="fit">', field, '</th><td ' + dispStyle(field) + '>', disp(e[field]), '</td></tr>');
  }
  return html.concat('</tbody></table>');
}

function importShowWord(word, eng, kanji, type) {
  var e = {};
  if (eng)
    e.english = eng;
  if (kanji)
    e.kanji = kanji;
  if (type)
    e.type = type;
  return '<li class="list-group-item"><h4 class="list-group-item-heading" ' + dispStyle('word') + '>' + disp(word) + '<div class="btn-group"><button class="btn btn-sm btn-info"><span class="fa fa-copy"></span></button></div></h4><p class="list-group-item-text"><table><tbody>' + importWordTable(e) + '</tbody></table></li>';
}

function importCSV(contents) {
  var arrays = $.csv.toArrays(contents, {delimiter: '"', separator: ','});
  var html = '';
  var i;
  for (i in arrays) {
    var a = arrays[i];
    if (a[2] == a[1])
      a[2] = '';
    html = html.concat(importShowWord(a[1], a[0], a[2], a[3]));
  }
  var wl = $('#unit_import #word_list');
  wl.children('ul').html(html);
  wl.show(ani);
}

$('#unit_import').on('shown.bs.modal', function() {autosize.update($('#unit_import textarea'));});

$('#unit_import #csv_file').on('change', function(e) {
  var file = e.target.files[0];
  if (!file)
    return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    importCSV(contents);
  }
  reader.readAsText(file);
});

function importUnit() {
  $('#unit_import .texteditor input').val(unit);
  $('#unit_import #csv_file').val('');
  $('#unit_import #word_list').children('ul').html('');
  $('#unit_import').modal();
}
  </script>
  <!-- }}} -->

  <!-- {{{ Word list -->
  <p>
  <div id="word_list" style="display:none"><ul class="list-group"></ul></div>
  <script>
function refreshWords(unit)
{
  var wl = $('.container > #word_list');
  if (unit == '') {
    wl.children('ul').html('');
    return;
  }
  $.getJSON('get/word_list.php?id=' + section + '&unit=' + unit, function(array) {
    var html = '';
    for (i in array)
      html = html.concat(wordElement(array[i]));
    wl.children('ul').html(html);
    wl.show(ani);
  });
}

function refreshWord(item)
{
  $.getJSON('get/word.php?id=' + section + '&wid=' + item.attr('wid'), function(obj) {
    if (obj == null) {
      item.hide(ani, item.remove);
      return;
    }
    item.removeClass('list-group-item-warning');
    item.replaceWith(wordElement(obj));
  });
}

// Edit or cancel button
$('#word_list').on('click', '.btn-warning', function() {
  var item = $(this).closest('li');
  if (item.hasClass('list-group-item-warning')) {
    // Discard changes
    refreshWord(item);
  } else {
    // Display editing panel
    var wid = item.attr('wid');
    $.getJSON('get/word.php?id=' + section + '&wid=' + wid, function(obj) {
      if (obj == null)
        return;
      item.addClass('list-group-item-warning');
      item.html(textEditor('Unit', unit == '(default)' ? '' : unit) + '<p>' + nameEditor('Word', obj.word) + '<p><table class="table"><tbody class="jsonedit info">' + jsonedit(obj['info']) + '</tbody></table>');
      autosize(item.find('textarea'));
    });
  }
});

// Accept button
$('#word_list').on('click', '.nameeditor .btn-success', function() {
  var item = $(this).closest('li');
  var obj = {id: section, wid: item.attr('wid'), unit: item.find('.texteditor input').val(),
    word: item.find('.nameeditor textarea').val(), info: JSON.stringify(jsonobj(item.find('tbody.info')))};
  if (obj.id == '' || obj.word == '')
    return;
  $.post('set/word.php', JSON.stringify(obj), function(res) {
    if (res == '')
      return;
    // Remove the word if unit is different, otherwise refresh it
    if (res != unit) {
      refreshUnits(section);
      item.hide(ani, item.remove);
    } else
      refreshWord(item);
  });
});

// Delete button
$('#word_list').on('click', '.nameeditor .btn-danger', function() {
  var item = $(this).closest('li');
  var wid = item.attr('wid');
  if (confirm('DELETE word #' + wid + '?'))
    $.post('set/delete_word.php', 'id=' + section + '&wid=' + wid, function() {
      refreshWord(item);
      refreshUnits(section);
    });
});
  </script>
  <!-- }}} -->

  <!-- {{{ Word copying modal dialog -->
  <div id="word_copy" class="modal fade" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title"></h4>
          <button type="button" class="close" data-dismiss="modal"><span class="fa fa-times"></span></button>
        </div>
        <div class="modal-body">
          <div class="copy_field">With annotations:
            <textarea class="form-control" type="text" placeholder="With annotation" rows=1></textarea><p></div>
          <div class="copy_field">Annotations:
            <textarea class="form-control" type="text" placeholder="Annotations" rows=1></textarea><p></div>
          <div class="copy_field">Word:
            <textarea class="form-control" type="text" placeholder="Word" rows=1></textarea><p></div>
          <div class="copy_field">HTML:
            <textarea class="form-control" type="text" placeholder="HTML" rows=1></textarea><p></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script>
$('#word_copy').on('shown.bs.modal', function() {autosize.update($('#word_copy textarea'));});

// Copy button
$('#word_list').on('click', '.btn-info', function() {
  var wid = $(this).closest('li').attr('wid');
  var html = $(this).closest('.list-group-item-heading').html().replace(/<div((?!<\/div>).)*<\/div>/g, '');
  var text = html.replace(/<br[^>]*>/g, '\n').replace(/<rp>((?!<\/rp>).)*<\/rp>/g, '').replace(/<rt>((?!<\/rt>).)*<\/rt>/g, '').replace(/<[^>]*>/g, '');
  var ruby = html.replace(/<br[^>]*>/g, '\n').replace(/<rp>[^<]*<\/rp>/g, '').replace(/<ruby>((?!(<rt>|<\/ruby>)).)*<rt>/g, '').replace(/<\/rt>((?!(<rt>|<\/ruby>)).)*<rt>/g, '').replace(/<[^>]*>/g, '');
  var plain = html.replace(/<br[^>]*>/g, '\n').replace(/<\/?rt>|<\/?rp>|<\/?ruby>/g, '');
  var ta = $('#word_copy textarea');
  var f = $('#word_copy .copy_field');
  if (plain != text)
    f.eq(0).show(0);
  else
    f.eq(0).hide(0);
  if (ruby != text)
    f.eq(1).show(0);
  else
    f.eq(1).hide(0);
  if (html != text)
    f.eq(3).show(0);
  else
    f.eq(3).hide(0);
  ta.eq(0).val(plain);
  ta.eq(1).val(ruby);
  ta.eq(2).val(text);
  ta.eq(3).val(html);
  $('#word_copy .modal-title').text('Word #' + wid + ':');
  $('#word_copy').modal();
});
  </script>
  <!-- }}} -->

  <!-- {{{ New word editor -->
  <div id="edit_word" style="display:none">
    <p>
    <div class="card">
      <div id="section_id" class="card-header bg-light">Add a new word</div>
      <div id="word_body" style="display:none">
        <div class="card-body">
          <script>document.write(textEditor('Unit', ''));</script><p>
          <script>document.write(nameEditor('Word', ''));</script><p>
          <table class="table"><tbody id="word_info" class="jsonedit">
            <script>document.write(jsonfield('', ''));</script>
          </tbody></table>
        </div>
      </div>
    </div>
  </div>
  <script>
function refreshEditWord(unit)
{
  $('#word_body .texteditor input').val(unit == '(default)' ? '' : unit);
  $('#word_body .nameeditor textarea').val('');
  autosize.update($('#word_body .nameeditor textarea'));
  $('#word_info').html(jsonfield('', ''));
  autosize($('#edit_word textarea'));
}

$('#edit_word .card-header').click(function() {$('#word_body').toggle(ani);});
$('#word_body .nameeditor .btn-warning').click(function() {$('#word_body').hide(ani);});

$('#word_body .nameeditor .btn-success').click(function() {
  var obj = {id: section, wid: null, unit: $('#word_body .texteditor input').val(), word: $('#word_body .nameeditor textarea').val(), info: JSON.stringify(jsonobj($('#word_info')))};
  if (obj.id == '' || obj.word == '')
    return;
  $.post('set/word.php', JSON.stringify(obj), function(res) {
    if (res == unit)
      refreshWords(unit);
    else
      refreshUnits(section);
    $('#word_body .nameeditor textarea').val('');
    $('#word_info td textarea').val('');
    autosize.update($('#edit_word textarea'));
  });
});

$('#word_body .nameeditor .btn-danger').click(function() {refreshEditWord(unit);});
  </script>
  <!-- }}} -->

</div>
<script>
function addSection()
{
  var name = prompt('Add new section:');
  if (name == null || name == '')
    return;
  $.post('set/new_section.php', 'name=' + name, refreshSections);
}

var ani = 120;  // Animation speed
autosize($('textarea'));
refreshSections();
</script>
</body>
</html>
