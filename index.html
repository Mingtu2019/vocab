<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <link rel="stylesheet" href="theme.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>
<body>
<script>
function nameEditor(name, value)
{
  return '<div class="input-group nameeditor"><div class="input-group-btn"><button class="btn btn-danger"><span class="glyphicon glyphicon-trash"></span></button><button class="btn btn-warning"><span class="glyphicon glyphicon-remove"></span></button><button class="btn btn-success"><span class="glyphicon glyphicon-ok"></span></button></div><input class="form-control" type="text" placeholder="' + name + '" value="' + value + '"></div>';
}

function textEditor(name, value)
{
  return '<div class="input-group texteditor"><span class="input-group-addon">' + name + '</span><input class="form-control" type="text" value="' + value + '"></div>';
}

// {{{ HTML word display
function disp(s) {
  return s.replace(/`[^`|]*`/g, function(s) {
    return '<rt>' + s.substring(1, s.length - 1) + '</rt>';
  }).replace(/`[^`|]*\|/g, function(s) {
    return '<rt>' + s.substring(1, s.length - 1) + '</rt>|';
  }).replace(/\|[^|]*\|/g, function(s) {
    return '<ruby>' + s.substring(1, s.length - 1) + '</ruby>';
  }).replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
}

function dispStyle(type) {
  if (type in style)
    return 'style="' + style[type] + '"';
  else
    return '';
}

function wordDisp(obj) {
  var html = '<table class="table table-condensed"><tbody>';
  var info = JSON.parse(obj.info);
  for (field in info) {
    html = html.concat('<tr><th class="fit">', field, '</th><td ' + dispStyle(field) + '>', disp(info[field]), '</td></tr>');
  }
  return html.concat('</tbody></table>');
}

function wordElement(word) {
  return '<li class="list-group-item" wid="' + word.id + '"><h4 class="list-group-item-heading" ' + dispStyle('word') + '>' + disp(word.word) + '<button class="btn btn-sm btn-warning"><span class="glyphicon glyphicon-pencil"></span></button></h4><p class="list-group-item-text"><table><tbody>' + wordDisp(word) + '</tbody></table></p></li>';
}
// }}}

// {{{ JSON editor functions
function jsonedit(json) {
  if (json === "")
    return '';
  var obj = JSON.parse(json);
  var html = '';
  for (field in obj)
    html = html.concat(jsonfield(field, obj[field]));
  return html.concat(jsonfield('', ''));
}

function jsonfield(field, value) {
  return '<tr><th class="fit"><div class="input-group"><div class="input-group-btn"><button class="btn ' +
    (field ? 'btn-danger' : 'btn-success') + '"><span class="glyphicon ' + (field ? 'glyphicon-remove' : 'glyphicon-plus') +
    '"></span></button></div><input class="form-control" type="text" id="field" value="' + field +
    '"></div></th><td><textarea class="form-control" type="text" id="value">' + value + '</textarea></td></tr>';
}

function jsonobj(table) {
  var obj = {};
  $(table).find("tr").each(function() {
    var field = $(this).find("th input").val();
    var value = $(this).find("td textarea").text();
    if (field != '' && value != '')
      obj[field] = value;
  });
  return obj;
}

$('body').on('click', '.jsonedit .btn-success', function() {
    var tr = $(this).closest('tr');
    var field = tr.find('#field').val();
    var value = tr.find('#value').val();
    if (field === "")
        return;
    $(this).removeClass('btn-success');
    $(this).addClass('btn-danger');
    $(this).children().removeClass('glyphicon-plus');
    $(this).children().addClass('glyphicon-remove');
    tr.parent().append(jsonfield('', ''));
});

$('body').on('click', '.jsonedit .btn-danger', function() {
    $(this).closest('tr').remove();
});
// }}}
</script>

<div class="container theme-showcase" role="main">

  <!-- {{{ Section tabs -->
  <ul class="nav nav-tabs" role="tablist" id="sectabs"></ul>
  <script>
function refreshSections()
{
  $.getJSON("get/section_list.php", function(res) {
    var html = '';
    for (i in res) {
      var obj = res[i];
      var id = obj['id'];
      var name = obj['name'];
      html = html.concat('<li><a href="#section" section="', id, '" data-toggle="tab">', name, '</a></li>');
    }
    html = html.concat('<li><a href="#section" section="add"><span class="glyphicon glyphicon-plus"></span></a></li>');
    $('#sectabs').html(html);
    refreshUnits(null);
    section = '';
    $('#edit_section').hide(ani);
    $('#edit_word').hide(ani);
  });
}

var section = ''
var secobj = {};
var style = {}, weight = {};
$('#sectabs').on('click', 'a', function() {
  var secid = $(this).attr('section');
  if (secid == "add")
    addSection();
  else if (secid != section) {
    var a = $(this);
    $.getJSON("get/section.php?id=" + secid, function(obj) {
      refreshUnits(secid);
      secobj = obj;
      section = obj.id;
      style = JSON.parse(obj.style);
      if (style == null)
        style = {};
      weight = JSON.parse(obj.weight);
      if (weight == null)
        weight = {};
      a.closest('ul').find('.btn-warning').remove();
      a.append('<button class="btn btn-xs btn-warning"><span class="glyphicon glyphicon-pencil"></span></button>');
      $('#edit_section').hide(ani);
      $('#edit_word').show(ani);
    });
  }
});
  </script>
  <!-- }}} -->

  <!-- {{{ Section editor -->
  <div id="edit_section" hidden>
    <p></p>
    <div class="panel panel-warning">
      <div class="panel-heading">
        <h3 class="panel-title" id="section_id">Edit section #</h3>
      </div>
      <div class="panel-body">
        <table class="table table-no-border"><tbody>
          <tr><td colspan=2 id="section_name"><script>document.write(nameEditor('Section name', ''));</script></td></tr>
          <tr><th class="fit">Style</th><td>
              <table class="table table-no-border jsonedit">
                <tbody id="section_style"></tbody>
              </table>
            </td></tr>
          <tr><th class="fit">Weight</th><td>
              <table class="table table-no-border jsonedit">
                <tbody id="section_weight"></tbody>
              </table>
            </td></tr>
        </tbody></table>
      </div>
    </div>
  </div>
  <script>
function refreshEditSection()
{
  $('#section_id').text('Edit section #' + secobj.id);
  $('#section_name input').val(secobj.name);
  $('#section_style').html(jsonedit(secobj.style));
  $('#section_weight').html(jsonedit(secobj.weight));
}

$('#sectabs').on('click', '.btn-warning', function() {
  refreshEditSection();
  $('#edit_section').toggle(ani);
});

$('#section_name .nameeditor .btn-warning').click(function() {
  refreshEditSection();
  $('#edit_section').hide(ani);
});

$('#section_name .nameeditor .btn-success').click(function() {
  var obj = {id: section};
  obj['name'] = $('#section_name input').val();
  obj['style'] = JSON.stringify(jsonobj($('#section_style')));
  obj['weight'] = JSON.stringify(jsonobj($('#section_weight')));
  $.post("set/section.php", JSON.stringify(obj), function(res) {
    if (res !== 'OK')
      alert("Save unsuccessful");
    else
      refreshSections();
  });
});

$('#section_name .nameeditor .btn-danger').click(function() {
  if (confirm('DELETE section #' + section + '?'))
    $.post('set/delete_section.php', 'id=' + section, refreshSections);
});
  </script>
  <!-- }}} -->

  <!-- {{{ Unit tabs -->
  <p></p>
  <ul class="nav nav-pills" role="tablist" id="unittabs"></ul>
  <script>
var unit = '';
function refreshUnits(secid) {
  if (secid == null) {
    $('#unittabs').html('');
    unit = '';
    $('#word_list').hide(ani);
    return;
  }
  if (secid != section)
      unit = '';
  $.getJSON('get/unit_list.php?id=' + secid, function(array) {
    var found = false;
    var html = '';
    for (i in array) {
      var name = array[i][0];
      if (name == unit) {
        html = html.concat('<li class="active"><a href="#unit" data-toggle="tab">', name, '</a></li>');
        found = true;
      } else
        html = html.concat('<li><a href="#unit" data-toggle="tab">', name, '</a></li>');
    }
    $('#unittabs').html(html);
    if (found == false)
      $('#word_list').hide(ani);
  });
}

$('#unittabs').on('click', 'a', function() {
  unit = $(this).text();
  if (unit == '')
    return;
  refreshWords(unit);
  refreshEditWord(unit);
});
  </script>
  <!-- }}} -->

  <!-- {{{ Word list -->
  <div id="word_list" hidden>
    <p></p>
    <ul class="list-group"></ul>
  </div>
  <script>
function refreshWords(unit)
{
  if (unit == '') {
    $('#word_list').children('ul').html('');
    return;
  }
  $.getJSON('get/word_list.php?id=' + section + '&unit=' + unit, function(array) {
    var html = '';
    for (i in array)
      html = html.concat(wordElement(array[i]));
    $('#word_list').children('ul').html(html);
    $('#word_list').show(ani);
  });
}

function refreshWord(item)
{
  $.getJSON('get/word.php?id=' + section + '&wid=' + item.attr('wid'), function(obj) {
    if (obj == null) {
      item.hide(ani, item.remove);
      return;
    }
    item.removeClass('list-group-item-warning');
    item.replaceWith(wordElement(obj));
  });
}

$('#word_list').on('click', '.btn-warning', function() {
  var item = $(this).closest('li');
  if (item.hasClass('list-group-item-warning')) {
    // Discard changes
    refreshWord(item);
  } else {
    // Display editing panel
    var wid = item.attr('wid');
    $.getJSON('get/word.php?id=' + section + '&wid=' + wid, function(obj) {
      if (obj == null)
        return;
      item.addClass('list-group-item-warning');
      item.html(textEditor('Unit', unit) + '<p></p>' + nameEditor('Word', obj.word) + '<p></p><table class="table jsonedit"><tbody class="info">' + jsonedit(obj['info']) + '</tbody></table>');
    });
  }
});

$('#word_list').on('click', '.nameeditor .btn-success', function() {
  var item = $(this).closest('li');
  var obj = {id: section, wid: item.attr('wid'), unit: item.find('.texteditor input').val(),
    word: item.find('.nameeditor input').val(), info: JSON.stringify(jsonobj(item.find('tbody.info')))};
  if (obj.id == '' || obj.word == '')
    return;
  $.post('set/word.php', JSON.stringify(obj), function(res) {
    if (res == '')
      return;
    // Remove the word if unit is different, otherwise refresh it
    if (res != unit) {
      refreshUnits(section);
      item.hide(ani, item.remove);
    } else
      refreshWord(item);
  });
});

$('#word_list').on('click', '.nameeditor .btn-danger', function() {
  var item = $(this).closest('li');
  var wid = item.attr('wid');
  if (confirm('DELETE word #' + wid + '?'))
    $.post('set/delete_word.php', 'id=' + section + '&wid=' + wid, function() {
      refreshWord(item);
      refreshUnits(section);
    });
});
  </script>
  <!-- }}} -->

  <!-- {{{ New word editor -->
  <div id="edit_word" hidden>
    <p></p>
    <div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title" id="section_id">Add a new word</h3>
      </div>
      <div id="word_body" hidden>
        <div class="panel-body">
          <script>document.write(textEditor('Unit', ''));</script><p></p>
          <script>document.write(nameEditor('Word', ''));</script><p></p>
          <table class="table"><tbody id="word_info">
            <script>document.write(jsonfield('', ''));</script>
          </tbody></table>
        </div>
      </div>
    </div>
  </div>
  <script>
function refreshEditWord(unit)
{
  $('#word_body .texteditor input').val(unit);
}

$('#edit_word .panel-heading').click(function() {$('#word_body').toggle(ani);});

$('#word_body .nameeditor .btn-warning').click(function() {$('#word_body').hide(ani);});

$('#word_body .nameeditor .btn-success').click(function() {
  var obj = {id: section, wid: null, unit: $('#word_body .texteditor input').val(), word: $('#word_body .nameeditor input').val(), info: JSON.stringify(jsonobj($('#word_info')))};
  if (obj.id == '' || obj.word == '')
    return;
  $.post('set/word.php', JSON.stringify(obj), function(res) {
    if (res == unit)
      refreshWords(unit);
    else
      refreshUnits(section);
    $('#word_body .nameeditor input').val('');
    $('#word_info').html(jsonfield('', ''));
  });
});

$('#word_body .nameeditor .btn-danger').click(function() {
  $('#word_body .texteditor input').val(unit);
  $('#word_body .nameeditor input').val('');
  $('#word_info').html(jsonfield('', ''));
});
  </script>
  <!-- }}} -->

</div>
<script>
function addSection()
{
  var name = prompt('Add new section:');
  if (name == null || name == '')
    return;
  $.post('set/new_section.php', 'name=' + name, refreshSections);
}

var ani = 120;  // Animation speed
refreshSections();
</script>
</body>
</html>
